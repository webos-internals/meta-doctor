#!/bin/bash
# build-wr-pixiplus-2.1.0 script by Rod Whitby
# based on meta-meta script by Ed Cates
# modifications by 'rwcash' and 'John Steffes'
# intended to flash WoRld PixiPlus phones with a working webOS 2.1.0 image
#  Your mileage may vary

[ -d scripts ] || { echo "Run the script from the meta-doctor directory, not the scripts directory" ; exit ; }

W210_JAR_URL="http://palm.cdnetworks.net/rom/preplus/p210r0d03142011/eudep210rod/webosdoctorp101ueu-wr.jar"
W145_JAR_URL="http://palm.cdnetworks.net/rom/pixiplus/px145r0d06302010/wrep145rod/webosdoctorp121ewweu-wr.jar"
V1451_JAR_URL="http://palm.cdnetworks.net/rom/pixiplus/px1451r0d05182011/ver1z0np1451rod/webosdoctorp121ewwverizonwireless.jar"
A212_JAR_URL="http://palm.cdnetworks.net/rom/veer/p212r0d05132011/attp212rod/webosdoctorp160unaatt.jar"

P210_FILE="webosdoctorp121ewweu-wr-2.1.0.jar"
W210_FILE="webosdoctorp101ueu-wr-2.1.0.jar"
W145_FILE="webosdoctorp121ewweu-wr-1.4.5.jar"
V1451_FILE="webosdoctorp121ewwverizonwireless-1.4.5.1.jar"
A212_FILE="webosdoctorp160unaatt-2.1.2.jar"

W210_BUILD="preplus-p101ueu-wr-2.1.0"
W145_BUILD="pixiplus-p121ewweu-wr-1.4.5"
V1451_BUILD="pixiplus-p121eww-verizon-1.4.5.1"
A212_BUILD="veer-p160una-att-2.1.2"

W210_MD5="03566ac546d72c59d1cdc1af5a4da920"
W145_MD5="1b0c63976ef3bc783770e35cfad55e5f"
V1451_MD5="0cd21b1f65b021787c8c83d7529adfaa"
A212_MD5="bb2743f0a30abdb62c03b071d149c5a6"

PATIENT="build-wr-pixiplus-2.1.0"
DOCTOR="pixiplus-p121ewweu-wr-1.4.5"

git="git"
wget="wget"
make="make"
java="java"
patch="patch"
tar="tar"
python="python"

case "`uname -s`" in
    "CYGWIN"* )
	echo "Using Cygwin on Windows is not a valid MetaDoctor option.  See the Wiki page and use WUBI instead."
	exit
	;;
    "Darwin" )
	tar=gnutar
	export COPYFILE_DISABLE=true
	export COPY_EXTENDED_ATTRIBUTES_DISABLE=true
	;;
esac

CARRIER_TARBALL="carrier.tar"
PIXIXML="pixie.xml"
VEERXML="broadway.xml"
BUILD_INFO="palm-build-info"
CUSTOM_ROOTFS="rootfs.tar"
WEBOS_TARBALL="webOS.tar"
UMTS_FW="pixieumtsfw.tar"

rm -rf ${CARRIER_TARBALL} ${PIXIXML} ${VEERXML} ${BUILD_INFO} ${CUSTOM_ROOTFS} ${CUSTOM_ROOTFS}.gz ${WEBOS_TARBALL} ${UMTS_FW}

echo "Due to changes made to HP Cloud Services, this script may no longer work."

for f in $git $wget $make $java $patch $python $tar ; do
	
    which $f > /dev/null || { echo "Cannot find $f.  Please install it." ; exit ; }

done

ARGS=
V1451_IPKS=

if [ "$1" = "--wifi-only" ] ; then
    ARGS="BYPASS_ACTIVATION=1 BYPASS_FIRST_USE_APP=1 DISABLE_MODEM_UPDATE=1"
    V1451_IPKS=
fi

V1451_IPKS="${V1451_IPKS} \
amazonservice_*.ipk \
com.palm.app.amazonstore_*.ipk \
com.palm.app.mobilehotspot_*.ipk \
"

ARGS="${ARGS} CUSTOM_BOOTLOGO=scripts/BootLogo.tga CUSTOM_WEBOS_DMSET=312 CUSTOM_CARRIER_DMSET=674 CUSTOM_WEBOS_TARBALL=${WEBOS_TARBALL} CUSTOM_ROOTFS=${CUSTOM_ROOTFS}.gz CUSTOM_XML=${PIXIXML} CUSTOM_CARRIER_TARBALL=${CARRIER_TARBALL} CUSTOM_BUILD_INFO=${BUILD_INFO} PATIENT=${PATIENT} VERSION=1.4.5 DEVICE=pixiplus CARRIER=wr"

$make ${ARGS} settings

echo
echo "Your custom doctor file will be created at build/${PATIENT}/${P210_FILE}"
echo

mkdir -p downloads

[ ! -f downloads/${W210_FILE} ] && $wget -c ${W210_JAR_URL} -O downloads/${W210_FILE}
[ ! -f downloads/${W145_FILE} ]  && $wget -c ${W145_JAR_URL}  -O downloads/${W145_FILE}
[ ! -f downloads/${V1451_FILE} ] && $wget -c ${V1451_JAR_URL} -O downloads/${V1451_FILE}
[ ! -f downloads/${A212_FILE} ] && $wget -c ${A212_JAR_URL} -O downloads/${A212_FILE}

[ $(md5sum downloads/${W210_FILE} | cut -d \  -f 1) != ${W210_MD5} ] && \
        echo "${W210_FILE} did not download properly.  Please run this script again." && \
        rm -f downloads/${W210_FILE} && exit
[ $(md5sum downloads/${W145_FILE}  | cut -d \  -f 1) != ${W145_MD5} ]  && \
        echo "${W145_FILE} did not download properly.  Please run this script again." && \
        rm -f downloads/${W145_FILE}  && exit
[ $(md5sum downloads/${V1451_FILE} | cut -d \  -f 1) != ${V1451_MD5} ] && \
        echo "${V1451_FILE} did not download properly.  Please run this script again." && \
        rm -f downloads/${V1451_FILE} && exit
[ $(md5sum downloads/${A212_FILE} | cut -d \  -f 1) != ${A212_MD5} ] && \
        echo "${A212_FILE} did not download properly.  Please run this script again." && \
        rm -f downloads/${A212_FILE} && exit

# $make clobber

echo "Unpacking if needed webOS Doctors"
$make VERSION=2.1.0 DEVICE=preplus CARRIER=wr unpack > /dev/null || exit
$make VERSION=1.4.5 DEVICE=pixiplus CARRIER=wr unpack > /dev/null || exit
$make VERSION=1.4.5.1 DEVICE=pixiplus CARRIER=verizon unpack > /dev/null || exit
$make VERSION=2.1.2 DEVICE=veer CARRIER=att unpack > /dev/null || exit

[ -d ./build/${DOCTOR}/210 ] || { echo "Not prepared for webOS 2.1.0 build extract" ; echo "Please create 210 directory under ${DOCTOR}" ; exit ; }
[ ! -f ./build/${DOCTOR}/210/e4014e63a755ac02a63478047ad21d7e.tgz ] || { echo "Ungziping rootfs tar file" ; gzip -d ./build/${DOCTOR}/210/e4014e63a755ac02a63478047ad21d7e.tgz ; }
[ ! -f ./build/${DOCTOR}/210/fixi.tgz ] || { echo "Ungziping fixi tar file" ; gzip -d ./build/${DOCTOR}/210/fixi.tgz ; }
[ -f ./build/${DOCTOR}/210/nova-cust-image-broadway.rootfs.tar ] || { echo "Copying Veer rootfs for webOS 2.1.2 build extract" ; cp ./build/veer-p160una-att-2.1.2/webOS/nova-cust-image-broadway.rootfs.tar ./build/${DOCTOR}/210/nova-cust-image-broadway.rootfs.tar ; }
[ -f ./build/${DOCTOR}/210/e4014e63a755ac02a63478047ad21d7e.tar ] || { echo "Not prepared for webOS 2.1.0 build extract" ; echo "webOS 2.1.0 rootfs file not present" ;  exit ; }
[ -f ./build/${DOCTOR}/210/fixi.tar ] || { echo "Not prepared for webOS 2.1.0 build extract" ; echo "webOS 2.1.0 fixi file not present" ;  exit ; }
[ -f ./scripts/BootLogo.tga ] || { echo "Custom Boot Image not found" ; echo "Ungzipping and untaring HP BootLogo.tga from Veer webOS 2.1.2" ; mkdir -p ./build/${DOCTOR}/210/BOOTIMG ; cp ./build/veer-p160una-att-2.1.2/rootfs/boot/boot-images.tar.gz ./build/${DOCTOR}/210/BOOTIMG ; gzip -d ./build/${DOCTOR}/210/BOOTIMG/boot-images.tar.gz ; $tar -xvf ./build/${DOCTOR}/210/BOOTIMG/boot-images.tar BootLogo.tga > /dev/null ; mv BootLogo.tga ./scripts/ ; rm -rf ./build/${DOCTOR}/210/BOOTIMG ; }

echo "Fixing PixiPlus webOS 2.1.0 rootfs tar missing files"
rm -rf ./build/${DOCTOR}/210/files ./build/${DOCTOR}/210/rootfs ./build/${DOCTOR}/210/flash.tar ./build/${DOCTOR}/210/nova-cust-image-pixie.rootfs.tar
mkdir -p ./build/${DOCTOR}/210/files/boot ./build/${DOCTOR}/210/rootfs 
cp ./build/${DOCTOR}/210/e4014e63a755ac02a63478047ad21d7e.tar ./build/${DOCTOR}/210/nova-cust-image-pixie.rootfs.tar

echo "Fixing PixiPlus webOS 2.1.0 boot files"
echo "./boot-images.tar.gz" > ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./image-update.xml" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./boot.bin" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./System.map-2.6.24-palm-chuck" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./config-2.6.24-palm-chuck" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./uImage-2.6.24-palm-chuck" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./uImage" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./updatefs-info" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./lib/ld-2.8.so" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./lib/libc-2.8.so" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./lib/libm-2.8.so" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt

$tar -C build/${DOCTOR}/210/files/boot --wildcards \
  -f build/${DOCTOR}/210/fixi.tar \
  -x -T ./build/${DOCTOR}/210/ipkgs-extract-list.txt

rm -f ./build/${DOCTOR}/210/ipkgs-extract-list.txt

echo "Fixing PixiPlus webOS 2.1.0 flash files"
$make VERSION=1.4.5 DEVICE=pixiplus CARRIER=wr \
    EXTRA_ROOTFS_IPKGS="flash-mini-adapter" \
    EXTRA_ROOTFS_TARBALL=./build/${DOCTOR}/210/flash.tar extract-rootfs-ipkgs > /dev/null || exit

echo "./usr/lib/BrowserServerPlugins/FlashMiniAdapterData/plugin-icon-noplay.png" > ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/lib/BrowserServerPlugins/FlashMiniAdapterData/plugin-icon-play.png" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/lib/BrowserServerPlugins/FlashMiniAdapterData/plugin-icon-unknown.png" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/lib/BrowserServerPlugins/FlashMiniAdapterData/plugin-scrim.png" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/lib/BrowserServerPlugins/FlashMiniPlugin.so" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/lib/ipkg/info/flash-mini-adapter.md5sums" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt

$tar -C build/${DOCTOR}/210/files/ --wildcards \
  -f build/${DOCTOR}/210/flash.tar \
  -x -T ./build/${DOCTOR}/210/ipkgs-extract-list.txt

rm -f ./build/${DOCTOR}/210/ipkgs-extract-list.txt

echo "Fixing PixiPlus webOS 2.1.0 Framework files"
echo "./var/palm/event.d/datatransferassistant" > ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/smartkey/XT9/DefaultData/autoreplace/en_us/text-edit-autoreplace" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.accounts/framework_config.json" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.agendaview/framework_config.json" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.dataimport/framework_config.json" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.network/framework_config.json" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.oddcore/framework_config.json" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.searchpreferences/framework_config.json" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.textassist/framework_config.json" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.timedetails/framework_config.json" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.updates/framework_config.json" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.vpn/framework_config.json" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.wifi/framework_config.json" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/smartkey/XT9/DefaultData/autoreplace/en_gb/text-edit-autoreplace" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./etc/hosts" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt

$tar -C build/${DOCTOR}/210/files/ --wildcards \
  -f build/${DOCTOR}/210/nova-cust-image-broadway.rootfs.tar \
  -x -T ./build/${DOCTOR}/210/ipkgs-extract-list.txt

rm -rf ./build/${DOCTOR}/210/ipkgs-extract-list.txt ./build/${DOCTOR}/210/flash.tar

echo "Fixing PixiPlus webOS 2.1.0 md5sums file"
$tar -C build/${DOCTOR}/210/files/ --wildcards \
  -f build/${DOCTOR}/210/nova-cust-image-pixie.rootfs.tar \
  -x ./md5sums.gz

$tar -C build/${DOCTOR}/210 --wildcards \
  -f build/${DOCTOR}/210/nova-cust-image-pixie.rootfs.tar \
  --delete ./md5sums.gz

gzip -d build/${DOCTOR}/210/files/md5sums.gz

echo "Fixing STK/WLM Framework Config md5sums"
echo "./usr/palm/applications/com.palm.app.stk/framework_config.json" > ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.wlmcustomlogin/framework_config.json" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/lib/ipkg/info/com.palm.app.stk.md5sums" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/lib/ipkg/info/com.palm.app.wlmcustomlogin.md5sums" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt

$tar -C build/${DOCTOR}/210/files/ --wildcards \
  -f build/${DOCTOR}/210/nova-cust-image-pixie.rootfs.tar \
  -x -T ./build/${DOCTOR}/210/ipkgs-extract-list.txt

$tar -C build/${DOCTOR}/210/files --wildcards \
  -f build/${DOCTOR}/210/nova-cust-image-pixie.rootfs.tar \
  --delete -T ./build/${DOCTOR}/210/ipkgs-extract-list.txt

rm -rf ./build/${DOCTOR}/210/ipkgs-extract-list.txt

cd build/${DOCTOR}/210/files
md5sum ./usr/palm/applications/com.palm.app.stk/framework_config.json > ./usr/lib/ipkg/info/com.palm.app.stk.md5sums.new
md5sum ./usr/palm/applications/com.palm.app.wlmcustomlogin/framework_config.json > ./usr/lib/ipkg/info/com.palm.app.wlmcustomlogin.md5sums.new
mv ./usr/lib/ipkg/info/com.palm.app.stk.md5sums ./usr/lib/ipkg/info/com.palm.app.stk.md5sums.old
../../../../scripts/replace-md5sums.py \
	./usr/lib/ipkg/info/com.palm.app.stk.md5sums.old ./usr/lib/ipkg/info/com.palm.app.stk.md5sums.new \
	      > ./usr/lib/ipkg/info/com.palm.app.stk.md5sums
mv ./usr/lib/ipkg/info/com.palm.app.wlmcustomlogin.md5sums ./usr/lib/ipkg/info/com.palm.app.wlmcustomlogin.md5sums.old
../../../../scripts/replace-md5sums.py \
	./usr/lib/ipkg/info/com.palm.app.wlmcustomlogin.md5sums.old ./usr/lib/ipkg/info/com.palm.app.wlmcustomlogin.md5sums.new \
	      > ./usr/lib/ipkg/info/com.palm.app.wlmcustomlogin.md5sums
rm -f ./usr/lib/ipkg/info/com.palm.app.stk.md5sums.old ./usr/lib/ipkg/info/com.palm.app.stk.md5sums.new ./usr/lib/ipkg/info/com.palm.app.wlmcustomlogin.md5sums.old ./usr/lib/ipkg/info/com.palm.app.wlmcustomlogin.md5sums.new
cd ../../../../

echo "Extracting UMTS Modem firmware file"
$tar --wildcards \
  -f build/${DOCTOR}/210/nova-cust-image-pixie.rootfs.tar \
  -x ./usr/lib/modem/pixieumts.tar.gz

mv ./usr/lib/modem/pixieumts.tar.gz ./pixieumtsfw.tar.gz
gzip -d pixieumtsfw.tar.gz
rm -rf usr

echo "Building webOS 2.1.0 info directory"
$tar -C build/${DOCTOR}/210/rootfs --wildcards \
  -f build/${DOCTOR}/210/nova-cust-image-pixie.rootfs.tar \
  -x ./usr/lib/ipkg/info || exit

echo "Removing files that do not belong in rootfs tar"
echo "./usr/palm/smartkey/XT9/DefaultData/autoreplace/en_us/text-edit-autoreplace.txt" > ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./lost+found/" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./media/preferences-assistant.js" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./scan_off_time_no_det" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./Settings/Trolltech.conf" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./Settings/" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/.flags/on_mount" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/.flags/" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/cache/configurator/*" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/cache/configurator/" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/cache/fontconfig/*" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/cache/ldconfig/aux-cache" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/cache/ldconfig/" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/cache/ld.so.cache" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/db/" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/file-cache/" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/home/" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/lib/ipkg/" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/lib/misc/" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/lib/pulse/" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/lib/software/" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/lib/til/" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/lib/update/lost+found/" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/log/*" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/lost+found/" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/luna/data/browser/" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/luna/data/Customization/" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/luna/data/extractfs/" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/luna/data/*" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/luna/launchpoints/" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/luna/preferences/" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/palm/event.d/lnsa_marker" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/palm/system-services/" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/preferences/" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/pubsub/" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/usr/" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./media/internal/*" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/ssl/*" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/ssl" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/palm/data/*" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./var/palm/data" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.accounts/framework_config.json" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.agendaview/framework_config.json" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.dataimport/framework_config.json" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.network/framework_config.json" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.oddcore/framework_config.json" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.searchpreferences/framework_config.json" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.textassist/framework_config.json" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.timedetails/framework_config.json" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.updates/framework_config.json" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.vpn/framework_config.json" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.wifi/framework_config.json" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/smartkey/XT9/DefaultData/autoreplace/en_gb/text-edit-autoreplace" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./etc/hosts" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/lib/ipkg/info/flash-mini-adapter.md5sums" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/lib/luna/system/luna-systemui/resources/zh_cn/views/devicemenu/devicemenu-scene.html" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./etc/fs.d/do_format_dev_mapper_store-filecache.sh" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./etc/fs.d/do_format_dev_mapper_store-log.sh" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./etc/fs.d/do_format_dev_mapper_store-media.sh" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./etc/fs.d/do_format_dev_mapper_store-mojodb.sh" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./etc/fs.d/do_format_dev_mapper_store-root.sh" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./etc/fs.d/do_format_dev_mapper_store-update.sh" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./etc/fs.d/do_format_dev_mapper_store-var.sh" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./etc/mtools.conf" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./etc/ndi-skipped-first-use" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./etc/palm/autoreplace/en_us/text-edit-autoreplace" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./etc/resolv.conf" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/share/fonts/ariblk.ttf" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/share/fonts/tahoma.ttf" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/share/fonts/tahomabd.ttf" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/share/fonts/verdanaz.ttf" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt

$tar -C build/${DOCTOR}/210 --wildcards \
  -f build/${DOCTOR}/210/nova-cust-image-pixie.rootfs.tar \
  --delete -T build/${DOCTOR}/210/ipkgs-delete-list.txt

rm -f ./build/${DOCTOR}/210/ipkgs-delete-list.txt

echo "Removing Bad Boot files from rootfs tar"
echo "./boot/*" > ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./boot" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt

$tar -C build/${DOCTOR}/210 --wildcards \
  -f build/${DOCTOR}/210/nova-cust-image-pixie.rootfs.tar \
  --delete -T build/${DOCTOR}/210/ipkgs-delete-list.txt

rm -f ./build/${DOCTOR}/210/ipkgs-delete-list.txt

echo "Removing all webosinternals hacks from rootfs tar"
echo "./usr/palm/frameworks/webview/submission/23.1/javascript/widget_webview.js.webosinternals.orig" > ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/frameworks/webview/submission/23.1/javascript/widget_webview.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/frameworks/webview/submission/23.1/javascript/widget_webview.js" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/frameworks/mojo2/mojo.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/frameworks/mojo2/mojo.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/frameworks/mojo2/mojo.js" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/frameworks/mojo/mojo.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/frameworks/mojo/mojo.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/frameworks/mojo/mojo.js" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.email/app/controllers/message-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.email/app/controllers/message-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.email/app/controllers/message-assistant.js" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.email/app/models/Attachments.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.email/app/models/Attachments.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.email/app/models/Attachments.js" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.phone/app/controllers/stageAssistants/phoneAppStage-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.phone/app/controllers/stageAssistants/phoneAppStage-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.phone/app/controllers/stageAssistants/phoneAppStage-assistant.js" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.phone/app/controllers/announcer-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.phone/app/controllers/announcer-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.phone/app/controllers/announcer-assistant.js" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.pdfviewer/sources.json.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.pdfviewer/sources.json.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.pdfviewer/sources.json" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.pdfviewer/app/views/preferences/preferences-scene.html.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.pdfviewer/app/views/preferences/preferences-scene.html" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.pdfviewer/app/views/document/document-scene.html.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.pdfviewer/app/views/document/document-scene.html.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.pdfviewer/app/views/document/document-scene.html" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.pdfviewer/app/views/document/header_bar.html.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.pdfviewer/app/views/document/header_bar.html.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.pdfviewer/app/views/document/header_bar.html" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.pdfviewer/app/views/document/command_bar.html.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.pdfviewer/app/views/document/command_bar.html.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.pdfviewer/app/views/document/command_bar.html" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.pdfviewer/app/controllers/app-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.pdfviewer/app/controllers/app-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.pdfviewer/app/controllers/app-assistant.js" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.pdfviewer/app/controllers/document-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.pdfviewer/app/controllers/document-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.pdfviewer/app/controllers/document-assistant.js" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.pdfviewer/app/controllers/preferences-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.pdfviewer/app/controllers/preferences-assistant.js" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.pdfviewer/app/controllers/recent-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.pdfviewer/app/controllers/recent-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.pdfviewer/app/controllers/recent-assistant.js" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.pdfviewer/stylesheets/pdf-viewer.css.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.pdfviewer/stylesheets/pdf-viewer.css.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.pdfviewer/stylesheets/pdf-viewer.css" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/resources/fr/views/chatview/chatview-scene.html.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/resources/fr/views/chatview/chatview-scene.html.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/resources/fr/views/chatview/chatview-scene.html" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/resources/es/views/chatview/chatview-scene.html.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/resources/es/views/chatview/chatview-scene.html.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/resources/es/views/chatview/chatview-scene.html" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/resources/de/views/chatview/chatview-scene.html.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/resources/de/views/chatview/chatview-scene.html.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/resources/de/views/chatview/chatview-scene.html" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/resources/it/views/chatview/chatview-scene.html.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/resources/it/views/chatview/chatview-scene.html.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/resources/it/views/chatview/chatview-scene.html" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/app/views/chatview/chatview-scene.html.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/app/views/chatview/chatview-scene.html.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/app/views/chatview/chatview-scene.html" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/app/views/compose/compose-scene.html.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/app/views/compose/compose-scene.html.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/app/views/compose/compose-scene.html" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/app/views/listview/historyList-row.html.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/app/views/listview/historyList-row.html.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/app/views/listview/historyList-row.html" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/app/utilities/CharacterCounter.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/app/utilities/CharacterCounter.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/app/utilities/CharacterCounter.js" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/app/controllers/compose-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/app/controllers/compose-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/app/controllers/compose-assistant.js" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/app/controllers/listview-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/app/controllers/listview-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/app/controllers/listview-assistant.js" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/app/controllers/chatview-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/app/controllers/chatview-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/app/controllers/chatview-assistant.js" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/stylesheets/messaging.css.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/stylesheets/messaging.css.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.messaging/stylesheets/messaging.css" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.maps/app/assistants/app-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.maps/app/assistants/app-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.maps/app/assistants/app-assistant.js" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.maps/app/assistants/mapshell-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.maps/app/assistants/mapshell-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.maps/app/assistants/mapshell-assistant.js" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.browser/app/views/page/page-scene.html.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.browser/app/views/page/page-scene.html.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.browser/app/views/page/page-scene.html" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.browser/app/controllers/page-controls.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.browser/app/controllers/page-controls.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.browser/app/controllers/page-controls.js" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.browser/app/controllers/page-navigationmenu.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.browser/app/controllers/page-navigationmenu.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.browser/app/controllers/page-navigationmenu.js" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.browser/app/controllers/page-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.browser/app/controllers/page-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.browser/app/controllers/page-assistant.js" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.youtube/app/controllers/video-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.youtube/app/controllers/video-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.youtube/app/controllers/video-assistant.js" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.camera/app/controllers/capture-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.camera/app/controllers/capture-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.camera/app/controllers/capture-assistant.js" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.camera/stylesheets/camera.css.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.camera/stylesheets/camera.css.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.camera/stylesheets/camera.css" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.devmodeswitcher/appinfo.json.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/palm/applications/com.palm.app.devmodeswitcher/appinfo.json.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/palm/applications/com.palm.app.devmodeswitcher/appinfo.json" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/lib/luna/system/luna-applauncher/app/controllers/launcherhelper-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/lib/luna/system/luna-applauncher/app/controllers/launcherhelper-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/lib/luna/system/luna-applauncher/app/controllers/launcherhelper-assistant.js" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/lib/luna/system/luna-systemui/app/views/bar/bar-scene.html.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/lib/luna/system/luna-systemui/app/views/bar/bar-scene.html.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/lib/luna/system/luna-systemui/app/views/bar/bar-scene.html" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/lib/luna/system/luna-systemui/app/controllers/bar-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/lib/luna/system/luna-systemui/app/controllers/bar-assistant.js.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/lib/luna/system/luna-systemui/app/controllers/bar-assistant.js" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/lib/luna/system/luna-systemui/stylesheets/systemui.css.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-extract-list.txt
echo "./usr/lib/luna/system/luna-systemui/stylesheets/systemui.css.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/lib/luna/system/luna-systemui/stylesheets/systemui.css" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./etc/audio/a/phone_front_speaker.txt.rej.webosinternals.orig" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./etc/audio/a/phone_front_speaker.txt.rej" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./usr/share/dbus-1/system-services/org.webosinternals.upstartmgr.service" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt
echo "./etc/event.d/org.webosinternals.upstartmgr" >> ./build/${DOCTOR}/210/ipkgs-delete-list.txt

$tar -C build/${DOCTOR}/210/files/ --wildcards \
  -f build/${DOCTOR}/210/nova-cust-image-pixie.rootfs.tar \
  -x -T ./build/${DOCTOR}/210/ipkgs-extract-list.txt

$tar -C build/${DOCTOR}/210 --wildcards \
  -f build/${DOCTOR}/210/nova-cust-image-pixie.rootfs.tar \
  --delete -T build/${DOCTOR}/210/ipkgs-delete-list.txt

rm -f ./build/${DOCTOR}/210/ipkgs-delete-list.txt ./build/${DOCTOR}/210/ipkgs-extract-list.txt

mv ./build/${DOCTOR}/210/files/usr/palm/frameworks/webview/submission/23.1/javascript/widget_webview.js.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/frameworks/webview/submission/23.1/javascript/widget_webview.js
mv ./build/${DOCTOR}/210/files/usr/palm/frameworks/mojo2/mojo.js.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/frameworks/mojo2/mojo.js
mv ./build/${DOCTOR}/210/files/usr/palm/frameworks/mojo/mojo.js.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/frameworks/mojo/mojo.js
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.email/app/controllers/message-assistant.js.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.email/app/controllers/message-assistant.js
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.email/app/models/Attachments.js.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.email/app/models/Attachments.js
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.phone/app/controllers/stageAssistants/phoneAppStage-assistant.js.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.phone/app/controllers/stageAssistants/phoneAppStage-assistant.js
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.phone/app/controllers/announcer-assistant.js.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.phone/app/controllers/announcer-assistant.js
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.pdfviewer/sources.json.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.pdfviewer/sources.json
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.pdfviewer/app/views/document/document-scene.html.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.pdfviewer/app/views/document/document-scene.html
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.pdfviewer/app/views/document/header_bar.html.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.pdfviewer/app/views/document/header_bar.html
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.pdfviewer/app/views/document/command_bar.html.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.pdfviewer/app/views/document/command_bar.html
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.pdfviewer/app/controllers/app-assistant.js.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.pdfviewer/app/controllers/app-assistant.js
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.pdfviewer/app/controllers/document-assistant.js.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.pdfviewer/app/controllers/document-assistant.js
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.pdfviewer/app/controllers/recent-assistant.js.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.pdfviewer/app/controllers/recent-assistant.js
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.pdfviewer/stylesheets/pdf-viewer.css.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.pdfviewer/stylesheets/pdf-viewer.css
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.messaging/resources/fr/views/chatview/chatview-scene.html.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.messaging/resources/fr/views/chatview/chatview-scene.html
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.messaging/resources/es/views/chatview/chatview-scene.html.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.messaging/resources/es/views/chatview/chatview-scene.html
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.messaging/resources/de/views/chatview/chatview-scene.html.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.messaging/resources/de/views/chatview/chatview-scene.html
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.messaging/resources/it/views/chatview/chatview-scene.html.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.messaging/resources/it/views/chatview/chatview-scene.html
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.messaging/app/views/chatview/chatview-scene.html.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.messaging/app/views/chatview/chatview-scene.html
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.messaging/app/views/compose/compose-scene.html.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.messaging/app/views/compose/compose-scene.html
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.messaging/app/views/listview/historyList-row.html.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.messaging/app/views/listview/historyList-row.html
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.messaging/app/utilities/CharacterCounter.js.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.messaging/app/utilities/CharacterCounter.js
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.messaging/app/controllers/compose-assistant.js.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.messaging/app/controllers/compose-assistant.js
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.messaging/app/controllers/listview-assistant.js.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.messaging/app/controllers/listview-assistant.js
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.messaging/app/controllers/chatview-assistant.js.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.messaging/app/controllers/chatview-assistant.js
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.messaging/stylesheets/messaging.css.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.messaging/stylesheets/messaging.css
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.maps/app/assistants/app-assistant.js.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.maps/app/assistants/app-assistant.js
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.maps/app/assistants/mapshell-assistant.js.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.maps/app/assistants/mapshell-assistant.js
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.browser/app/views/page/page-scene.html.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.browser/app/views/page/page-scene.html
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.browser/app/controllers/page-controls.js.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.browser/app/controllers/page-controls.js
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.browser/app/controllers/page-navigationmenu.js.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.browser/app/controllers/page-navigationmenu.js
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.browser/app/controllers/page-assistant.js.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.browser/app/controllers/page-assistant.js
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.youtube/app/controllers/video-assistant.js.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.youtube/app/controllers/video-assistant.js
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.camera/app/controllers/capture-assistant.js.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.camera/app/controllers/capture-assistant.js
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.camera/stylesheets/camera.css.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.camera/stylesheets/camera.css
mv ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.devmodeswitcher/appinfo.json.webosinternals.orig ./build/${DOCTOR}/210/files/usr/palm/applications/com.palm.app.devmodeswitcher/appinfo.json
mv ./build/${DOCTOR}/210/files/usr/lib/luna/system/luna-applauncher/app/controllers/launcherhelper-assistant.js.webosinternals.orig ./build/${DOCTOR}/210/files/usr/lib/luna/system/luna-applauncher/app/controllers/launcherhelper-assistant.js
mv ./build/${DOCTOR}/210/files/usr/lib/luna/system/luna-systemui/app/views/bar/bar-scene.html.webosinternals.orig ./build/${DOCTOR}/210/files/usr/lib/luna/system/luna-systemui/app/views/bar/bar-scene.html
mv ./build/${DOCTOR}/210/files/usr/lib/luna/system/luna-systemui/app/controllers/bar-assistant.js.webosinternals.orig ./build/${DOCTOR}/210/files/usr/lib/luna/system/luna-systemui/app/controllers/bar-assistant.js
mv ./build/${DOCTOR}/210/files/usr/lib/luna/system/luna-systemui/stylesheets/systemui.css.webosinternals.orig ./build/${DOCTOR}/210/files/usr/lib/luna/system/luna-systemui/stylesheets/systemui.css

$tar -C build/${DOCTOR}/210/files/ -f ./build/${DOCTOR}/210/nova-cust-image-pixie.rootfs.tar --append . || exit

rm -rf ./build/${DOCTOR}/210/files ./build/${DOCTOR}/210/rootfs

echo "Copying new rootfs to be used for meta doctor"
cp build/${DOCTOR}/210/nova-cust-image-pixie.rootfs.tar ${CUSTOM_ROOTFS}

echo "Compressing rootfs file"
gzip ${CUSTOM_ROOTFS}

echo "Fixing XML file for webOS 2.1.0 file structure"
head -n 28 build/${W145_BUILD}/webOS/${PIXIXML} > ${PIXIXML}
tail -n 33 build/${A212_BUILD}/webOS/${VEERXML} >> ${PIXIXML}
sed -e "s/504MB/196MB/g" ${PIXIXML} > ${VEERXML}
mv ${VEERXML} ${PIXIXML}

echo "Copying webOS 1.4.5 tarball to modify"
cp build/${W145_BUILD}/resources/${WEBOS_TARBALL} ./

echo "Updating webOS tarball with webOS 2.1.0 WoRld modem firmware"
$tar -C ./ -f ./${WEBOS_TARBALL} --delete ./${UMTS_FW} || exit
$tar -C ./ -f ./${WEBOS_TARBALL} --append ./${UMTS_FW} || exit

cp build/${W210_BUILD}/rootfs/etc/${BUILD_INFO} ./${BUILD_INFO}

echo "Building WoRld Carrier Apps from Verizon Carrier Apps"
mkdir -p carrier

( cd build/${W145_BUILD}/carrier ; \
    $tar -c -f - installer.xml) | ( cd carrier ; $tar -x -v -f - )
( cd build/${V1451_BUILD}/carrier ; \
    $tar -c -f - ${V1451_IPKS} ) | ( cd carrier ; $tar -x -v -f - )
( cd carrier ; $tar -c -f ../${CARRIER_TARBALL} installer.xml ${V1451_IPKS} )

rm -rf carrier

echo "Building WoRld PixiPlus webOS 2.1.0 base build doctor"
$make ${ARGS} clobber-build settings all > ./build/${DOCTOR}/210/PIXIBLD.TXT || exit

mv build/${PATIENT}/${W145_FILE} build/${PATIENT}/${P210_FILE}

rm -rf ${CARRIER_TARBALL} ${PIXIXML} ${VEERXML} ${BUILD_INFO} ${CUSTOM_ROOTFS} ${CUSTOM_ROOTFS}.gz ${WEBOS_TARBALL} ${UMTS_FW}

echo "Copying WoRld PixiPlus webOS 2.1.0 base build to downloads and unpacking"
cp build/${PATIENT}/${P210_FILE} downloads
rm -rf build/pixiplus-p121ewweu-wr-2.1.0
$make VERSION=2.1.0 DEVICE=pixiplus CARRIER=wr unpack > /dev/null || exit
